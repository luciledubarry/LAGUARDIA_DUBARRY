---
title: "Data Management Project: Location's impact on museum attendance"
author: Joséphine Laguardia and Lucile Dubarry
format: html
code-fold: true
echo: false
---

```{r}
#| message: false
here::i_am("LAGUARDIA_DUBARRY.Rproj")
library(ggplot2)
library(dplyr)
library(tidyr)
library(vroom)
library(here)
library(stringr)
library(scales)
```

```{r cleaning and merging}
#| message: false
museum <- vroom(here("musees-de-france-base-museofile.csv"))
freq <- vroom(here("frequentation-des-musees-de-france.csv"))
freq <- freq |> filter(annee == 2019)
freq <- freq |> filter(is.na(note))
freq <- freq |> select(id_museofile, nom_du_musee, regions, ville, total, payant, gratuit, nomdep)
museum <- museum |> select(ref, dompal, prot_bat, prot_esp, latitude, longitude)
museum <- museum |> rename(id_museofile = ref)
data <- inner_join(freq, museum, by = 'id_museofile')
```

# Research question

# Data sets description

# Data analysis

## Descriptive statistics

### Geographical distribution

  In this sub-section, we want to represent visually the cultural vitality of France and its regions.
  
  First, let's take a look into the number of museums in each region, and the corresponding percentage in regards to the whole country.

```{r}
#| message : false
vitality1 <- summarise(data |>
            group_by(regions),
            number = n(), 
            percentage = round(100*n()/1016,1))
knitr::kable(vitality1,
            col.names = c("Regions","Number of museums","Percentage of museums"))
```

  Multiple points are to be made here. With no surprise, "Île-de-France" is the most dynamic in terms of cultural vitality, with `r vitality1[10,2]` museums, corresponding to `r vitality1[10,3]` % of French museums. Paris being the capital of France, and the most visited city in the world, with more than 30 millions visitors per year, this result is understandable. To add another expected result, the biggest regions (in terms of surface area) are also very dynamic: Auvergne-Rhone-Alpes, Grand Est and Occitanie have the largest number of museums after Île-de-France. What is more surprising is Nouvelle-Aquitaine: it is the biggest region in France, and only includes around `r vitality1[14,3]` % of total museums in France. 

  Then, let's do the same process but in regards to the cumulative number of visits in each region, and the corresponding percentage.

```{r}
total_visits <- sum(data$total, na.rm = TRUE)

vitality2 <- summarise(data |>
            group_by(regions),
            cumulative = sum(total, na.rm = TRUE), 
            percentage2 = round(100*cumulative/total_visits,1)) |>
  mutate(cumulative = scales::comma(cumulative))

knitr::kable(vitality2,
            col.names = c("Regions","Number of visits","Percentage"))
```

  This table shows us the cultural power of the "Île-de-France" region. With only `r vitality1[10,3]` % of total french museums, this region captures almost 60% of total visitors in France. The region completely crushes the others' percentages. Nevertheless, we find again the biggest regions : Auvergne-Rhones-Alpes (`r vitality2[1,3]` %), Provence-Alpes-Côte d'Azur (`r vitality2[17,3]` %), Grand Est (`r vitality2[6,3]` %), and Occitanie (`r vitality2[15,3]` %).
  
  In order to compare the share of museums and the share of visitors a bit better, here is a graph showing them side by side.

```{r}
# we merge our two data frames
vit <- merge(vitality1,vitality2)
vit <- select(vit, - number, - cumulative)
# we rename the variables (for future aesthetic uses)
vit <- rename(vit, "% of total museums" = "percentage", "% of total visits" = "percentage2")
# we pivot longer (to represent both variables in a grouped way)
vit_long <- pivot_longer(vit, cols = c("% of total museums","% of total visits"), names_to = "Percentages")
# graph
gg <- ggplot(vit_long, aes(x= regions, y= value, fill = Percentages)) +
  geom_col(position = "dodge") +
  xlab("Regions") +
  ylab("Cultural vitality") +
  theme(axis.title = element_text(size = 15,
                                  color = "purple",
                                  face = "bold")) +
  scale_fill_hue(h = c(180, 270))
gg + coord_flip()
```
[description]

To go even further, we wanted to represent this cultural vitality on a map of France (because why not ?).


```{r}
#| message: false
# the packages we need 
library(sf)
library(tmap)
library(rmapshaper)
```

In order to do this, we had to introduce a new data base. This data base comes from the same source as our main bases, and includes French administrative boundaries at regional level (regional contours) from OpenStreetMap.
The *Contours des régions françaises sur OpenStreetMap* dataset is available [here](https://www.data.gouv.fr/fr/datasets/contours-des-regions-francaises-sur-openstreetmap/#_)

```{r}
# we introduce a new data base 
regions <- read_sf("regions-20180101-shp/")
```

```{r}
#| message: false
# merging the data bases
vitality <- merge(vitality1,vitality2)
# ordering in alphabetical order (so that each data base has the same order)
regions <- regions[order(regions$nom),,]
vitality <- vitality[order(vitality$regions),,]
# deleting the rows that weren't common to both data base
regions <- filter(regions, nom != "Mayotte")
vitality <- filter(vitality, regions != "ST PIERRE ET MIQUELON")
# creating an index (to facilitate the joining)
id <- as.character(1:17)
regions <- cbind(regions, id)
vitality <- cbind(vitality, id)
# joining the data bases 
regions_vitality <- full_join(regions,vitality, by = "id")
```

Here it is:

```{r}
#| message: false
# rename the variable (for future aesthetic purposes)
regions_vitality <- rename(regions_vitality, "Name of the region" = "nom")

regions1 <- ms_simplify(regions_vitality)
plot <- ggplot(regions1)+
  geom_sf(aes(fill= `Name of the region`))+
  coord_sf(xlim = c(-5.5,10),ylim=c(41,51))+
  theme_void() +
  geom_sf_label(aes(label = number))
plot + labs(title = "Cultural vitality in France", subtitle = "Number of museums in each french region")
```

Unfortunately, we were unable to represent the French overseas regions on this map. 

### City or not: Number of museums and frequentation records by city location

We now aim to assess how the distribution of museums, both in terms of number of museums and attendance, varies when they are located in densely populated cities. Does being located in large cities have a strong impact on museum attendance?

To find out, we separate museums into two categories, selecting the 10 largest cities in France: Paris, Marseille, Lyon, Toulouse, Nice, Nantes, Montpellier, Strasbourg, Bordeaux and Lille. We create the variable "city", worth 1 if the museum is located in 1 of these cities, 0 otherwise. 

```{r}
city <- function(ville) {
    if (grepl("PARIS|LYON|MARSEILLE|TOULOUSE|NICE|NANTES|MONTPELLIER|STRASBOURG|BORDEAUX|LILLE", ville, ignore.case = TRUE)) {
    return("1")
  } else {
    return("0")
  }
}

data$city <- sapply(data$ville, city)
```

```{r}
data |>
  group_by(city) |>
  summarise(total_museum = n()) |>
  ggplot(aes(x = city, y = total_museum)) +
  geom_bar(stat = "identity") +
  labs(title = "Number of museums by city location",
       x = "Location of the museum",
       y = "Number of museums") +
  scale_x_discrete(labels = c("other location", "city location"))
```

```{r}
perc5 <- data |>
  filter(city == "0") |>
  summarize(n = n()) |>
  mutate(percentage = n / nrow(data) * 100) |>
  mutate(percentage = round(percentage, 2))

perc6 <- data |>
  filter(city == "1") |>
  summarize(n = n()) |>
  mutate(percentage = n / nrow(data) * 100) |>
  mutate(percentage = round(percentage, 2))
```

In terms of the number of museums, the most populated cities do not account for a disproportionate number of museums in France, and `r perc5$percentage`% of museums are located outside major cities. 

```{r}
data |> filter(!is.na(total)) |>
  group_by(city) |>
  summarise(total_freq = sum(total)) |>
  ggplot(aes(x = city, y = total_freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Frequentation of museums by city location",
       x = "Location of the museum",
       y = "Cumulative frequentation") +
  scale_y_continuous(labels = scales::comma)+
  scale_x_discrete(labels = c("other location", "city location"))
```
```{r}
perc7 <- data |>
  filter(!is.na(total)) |>
  filter(city == "1") |>
  summarize(total_freq = sum(total)) |>
  mutate(percentage = total_freq / freq_total * 100) |>
  mutate(percentage = round(percentage, 2))
```

Although only `r perc6$percentage`% of museums are located in France's largest centers, these cities have an important drawing power. The cumulative attendance record of these 10 cities exceeds that of all other French museums combined, with almost 35 million visitors in 2019, representing `r perc7$percentage`% of total attendance this year.

### Capital or not: Number of museums and frequentation records in Paris

We can narrow our focus and observe whether being located in Paris has a significant impact on the number of museums and their attendance figures. 

We repeat the same operation than in the previous section for the capital. We create the variable "PARIS" such that it is equals to 1 is the museum is located in the capital, 0 otherwise. 

```{r}
PARIS <- function(ville) {
    if (grepl("PARIS", ville, ignore.case = TRUE)) {
    return("1")
  } else {
    return("0")
  }
}

data$PARIS <- sapply(data$ville, PARIS)
```

```{r}
data |>
  group_by(PARIS) |>
  summarise(total_museum = n()) |>
  ggplot(aes(x = PARIS, y = total_museum)) +
  geom_bar(stat = "identity") +
  labs(title = "Comparison of the number of museums in Paris and other location ",
       x = "Location of the museum",
       y = "Number of museums") +
  scale_x_discrete(labels = c("other location", "located in Paris"))
``` 
```{r}
perc8 <- data |>
  filter(PARIS == "1") |>
  summarize(n = n()) |>
  mutate(percentage = n / nrow(data) * 100) |>
  mutate(percentage = round(percentage, 2))
```

In terms of the number of museums, the capital does not seem to have a major impact on museum location. With only `r perc8$n` museums located in Paris, it represents `r perc8$percentage`% of the total French museums. 

```{r}
data |> filter(!is.na(total)) |>
  group_by(PARIS) |>
  summarise(total_freq = sum(total)) |>
  ggplot(aes(x = PARIS, y = total_freq)) +
  geom_bar(stat = "identity") +
  labs(title = "Frequentation of museums located in Paris and other location",
       x = "Location of the museum",
       y = "Cumulative frequentation") +
  scale_y_continuous(labels = scales::comma) +
  scale_x_discrete(labels = c("other location", "located in Paris"))
```
```{r}
perc9 <- data |>
  filter(!is.na(total)) |>
  filter(PARIS == "1") |>
  summarize(total_freq = sum(total)) |>
  mutate(percentage = total_freq / freq_total * 100) |>
  mutate(percentage = round(percentage, 2))
```

However, the result is not the same as regards the attendance record. With just `r perc8$n` museums located in Paris, the capital managed to attract almost 30 million of visitors in 2019, equivalent to `r perc9$percentage`% of this year's total attendance.

## Second characteristic of the museums: their themes

### Regroup museum theme into main categories

To facilitate the analysis, we decided to recategorize the variable dompal, so as to classify the museums into three categories that seem to us to be particularly distinct from each other, and which well characterize the type of museum: Art, History and Science. We construct the classification in such a way that museums can have several categories.

The Art category includes themes such as Beaux-arts, Art moderne, Arts décoratifs, etc. The History category consists of Histoire, Archéologie, Ethnologie, etc. Finally, the Science category is composed of Technique et industrie, Sciences fondamentales and Sciences de la nature. 

```{r}
category <- function(dompal) {
  categories <- character()

  if (grepl("Ethnologie|Archéologie|Histoire|esclavage", dompal, ignore.case = TRUE)) {
    categories <- c(categories, "History")
  }
  if (grepl("Art moderne et contemporain|Beaux-Arts|Arts décoratifs|Littérature|Musique|Photographie|Arts de l'Islam|Mode et textile|musique", dompal, ignore.case = TRUE)) {
    categories <- c(categories, "Art")
  }
  if (grepl("Sciences de la nature|Technique et industrie|Sciences fondamentales", dompal, ignore.case = TRUE)) {
    categories <- c(categories, "Science")
  }

  if (length(categories) == 0) {
    return(dompal)
  } else {
    return(paste(categories, collapse = ", "))
  }
}

data$category <- sapply(data$dompal, category)
```

```{r}
NA_count <- data |> filter(is.na(category))
```
`r count(NA_count)|>pull(n)` museums does not indicate a specific theme, then they will not be taken into account in the following representations. 

### Diversity of museum theme at the national scale

We study the diversity of museum subjects in France, by representing the distribution of the number of museums in each categories. 

We first study museum theme as a combination of categories (a museum type is composed between one and three categories), then we consider categories individually to determine the most frequent museum type in France. 

The following graph show the number of museums by category, keeping the categories as a group. 

```{r}
data |> filter(!is.na(category)) |> ggplot(aes(x = category)) +
  geom_bar() +
  labs(title = "Distribution of museum theme at the national scale",
       x = "Categories",
       y = "Number of museums") +
  coord_flip()
```

```{r}
perc1 <- data |>
  filter(category == "History, Art") |>
  summarize(n = n()) |>
  mutate(percentage = n / nrow(data) * 100) |>
  mutate(percentage = round(percentage, 2))
```

The most frequent group of museum categories in France is History and Art. With `r perc1$n` museums in this category, it represents `r perc1$percentage`% of the total number of museums in France. 

To determine the most frequent museum type, we will represent the number of museums in each category by considering the categories individually. In the following section, we have made the significant choice of considering that, since some museums have several different categories, they will be counted in each category in which they appear. 

```{r}
data_expanded <- data |> filter(!is.na(category)) |>
  mutate(category = str_split(category, ", ")) |>
  unnest(category)

category_count <- data_expanded |>
  group_by(category) |>
  summarise(total_museums = n())

ggplot(category_count, aes(x = category, y = total_museums)) +
  geom_bar(stat = "identity") +
  labs(title = "Distribution of museum theme (considering categories individually)",
       x = "Categories",
       y = "Number of museums")
```

The following table shows the percentage of museums that include the category in their description, relative to the total number of museums in France.

```{r}
category_count <- category_count |> 
  mutate(perc = total_museums/nrow(data)*100) |>
  mutate(perc = scales::percent(perc, scale = 1))

knitr::kable(category_count, col.names = c("Category","Number of museums","Proportion of museums indicating this category"))
```
We read the result as, for example, `r category_count[1,3]` of museums in France indicate the Art category (possibly among other categories). With `r category_count[2,3]` of the museums indicating History in their description, this is the most common type of museum in France, in terms of number of museums. 

Therefore, the most frequent category, when considering the categories individually is History, followed by Art. There is also a significant drop for Science museums, compared to the two other categories. However, we should keep in mind when analyzing the results that categories are often linked to each others, particularly History and Art. 

### Frequentation records depending on the museum type

We now focus on the attendance records depending on the type of museums, by representing the total frequentation for each categories. 

In the same way as in the previous section, we separate our analysis by studying the museum theme as a combination of categories and by considering the categories individually.

```{r}
data |> filter(!is.na(total)) |> filter(!is.na(category)) |>
  group_by(category) |>
  ggplot(aes(x = category, y = total)) +
  geom_bar(stat="identity") +
  labs(title = "Frequentation at the national level depending on types",
       x = "Categories",
       y = "Number of museums") +
  coord_flip() +
  scale_y_continuous(labels = scales::comma)
```

```{r}
freq_total <- data |> filter(!is.na(total)) |> summarize(freq_total = sum(total))

perc2 <- data |>
  filter(!is.na(total)) |>
  filter(category == "History, Art") |>
  summarize(total = sum(total)) |>
  mutate(percentage = total/freq_total * 100) |>
  mutate(total = scales::comma(total)) |>
  mutate(percentage = round(percentage, 2))
```

Visitors is not an evenly distributed asset! One category of museum (History and Art) is significantly ahead of the others in terms of attendance records, with `r perc2$total` visitors in 2019 which represents `r perc2$percentage`% of the total frequentation. 

```{r}
perc3 <- data |>
  filter(category == "History") |>
  summarize(n = n())

perc4 <- data |>
  filter(!is.na(total)) |>
  filter(category == "History") |>
  summarize(total = sum(total)) |>
  mutate(total = scales::comma(total))
```

Although this category is the most widespread in France, with `r perc1$n` museums classified as History and Art, this attendance record is particularly high, compared with those of other categories. The other most common categories do not achieve the same attendance figures. The category History shows a major difference between the number of museums and the frequentation track: `r perc3` museums are listed as being exclusively of the History type (representing the third most frequent museum type), but its frequentation record is in fourth place, with `r perc4` visitors in 2019. 

```{r}
freq_count <- data_expanded |>
  filter(!is.na(total)) |>
  group_by(category) |>
  summarise(freq_category = sum(total))

ggplot(freq_count, aes(x = category, y = freq_category)) +
  geom_bar(stat = "identity") +
  labs(title = "Frequentation of museums (considering categories individually)",
       x = "Categories",
       y = "Total frequentation") +
  scale_y_continuous(labels = scales::comma)
```

```{r}
freq_count <- freq_count |> 
  mutate(perc = freq_category/65623724*100) |>
  mutate(freq_category = scales::comma(freq_category)) |>
  mutate(perc = scales::percent(perc, scale = 1))

knitr::kable(freq_count, col.names = c("Category","Total frequentation","Proportion of frequentation for each category"))
```

Looking at the categories individually, we observe that Art museums leads the way in terms of attendance record, with `r freq_count[1,3]` of the visits in 2019 to museums featuring Art in their description. Although Art museums are not the most common type of museum in France (behind History museums), total attendance for this type exceeds that of History museums in 2019. Visitor numbers for History museums remain close, with `r freq_count[2,3]` of visits to museums classified as History.

It should be noted that frequentation between these two categories is highly interrelated, as museums categorized as both History and Art being the most prominent in France, both in terms of numbers of museums and attendance. 

We also notice a significant difference between the total attendance of Science museums and that of the other two categories, with only `r freq_count[3,3]` of visits concerning museums classified as Science. 

We can therefore conclude that the most popular museum theme in France is Art, followed very closely by History, a result largely due to the high attendance rates of museums classified in both the History and Art categories.

